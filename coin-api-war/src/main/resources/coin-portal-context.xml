<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:tx="http://www.springframework.org/schema/tx" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="
  http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
  http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd">

<context:component-scan base-package="nl.surfnet.coin.portal" />

  <!-- <task:annotation-driven executor="mailExecutor" /> <task:executor 
    id="mailExecutor" pool-size="5-25" queue-capacity="100" /> -->
  <!--<task:scheduler id="mailScheduler" pool-size="10" /> -->

  <bean id="log4jInitialization"
    class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetClass" value="org.springframework.util.Log4jConfigurer" />
    <property name="targetMethod" value="initLogging" />
    <property name="arguments">
      <list>
        <value>classpath:log4j.xml</value>
        <value>5000</value>
      </list>
    </property>
  </bean>

  <bean id="coinEnvironment" class="nl.surfnet.coin.portal.util.CoinEnvironment">
    <property name="metadataUrl" value="${metadataUrl}" />
    <property name="idpMetadataUrl" value="${idpMetadataUrl}" />
    <property name="gadgetServerBase" value="${gadgetServerBase}" />
    <property name="targetServerBase" value="${targetServerBase}" />
    <property name="mockLogin" value="${mockLogin}" />
    <property name="mockName" value="${mockName}" />
    <property name="mockUserStatus" value="${mock-user-status}" />
    <property name="version" value="@VERSION@" />
    <property name="containerName" value="${containerName}" />
    <property name="allowCustomGadgets" value="${allowCustomGadgets}" />
    <property name="shindigDebug" value="${shindigDebug}" />
    <property name="shindigNocache" value="${shindigNocache}" />
    <property name="landingPageRssFeeds" value="${landingPageRssFeeds}" />
    <property name="textFieldIntroduction" value="${text-field-introduction}" />
    <property name="textFieldGettingStarted" value="${text-field-getting-started}" />
    <property name="profilePageUrl" value="${profilePageUrl}"/>
  </bean>

  <bean id="portalDataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource"
    destroy-method="close">
    <property name="driverClass" value="${coin-db-driver}" />
    <property name="jdbcUrl" value="${coin-db-url}" />
    <property name="user" value="${coin-db-username}" />
    <property name="password" value="${coin-db-password}" />
    <property name="initialPoolSize" value="1" />
    <property name="maxPoolSize" value="20" />
    <property name="minPoolSize" value="1" />
    <property name="acquireIncrement" value="2" />
    <property name="acquireRetryAttempts" value="15" />
    <!--Check every 15 minutes -->
    <property name="idleConnectionTestPeriod" value="15" />
    <property name="maxIdleTime" value="15" />
  </bean>

  <bean id="portalSessionFactory" autowire="byName"
    class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean">
    <property name="dataSource">
      <ref local="portalDataSource" />
    </property>
    <property name="hibernateProperties">
      <props>
        <prop key="hibernate.dialect">${hibernate.dialect}</prop>
        <!-- prop key="hibernate.cache.provider_class">org.hibernate.cache.EhCacheProvider</prop -->
        <prop key="hibernate.query.substitutions">true 1, false 0</prop>
        <prop key="hibernate.show_sql">${hibernate.show_sql}</prop>
        <prop key="hibernate.format_sql">${hibernate.format_sql}</prop>
        <prop key="hibernate.cache.use_second_level_cache">false</prop>
        <prop key="hibernate.hbm2ddl.auto">${hibernate.hbm2ddl.auto}</prop>
        <prop key="hibernate.cache.use_query_cache">false</prop>
        <prop key="hibernate.jdbc.wrap_result_sets">true</prop>
        <prop key="hibernate.connection.release_mode">on_close</prop>
        <prop key="hibernate.connection.provider_class">org.hibernate.connection.C3P0ConnectionProvider
        </prop>
        <prop key="hibernate.c3p0.min_size">2</prop>
        <prop key="hibernate.c3p0.max_size">10</prop>

        <prop key="hibernate.c3p0.acquireRetryAttempts">5</prop>
        <prop key="hibernate.c3p0.acquireIncrement">2</prop>
        <prop key="hibernate.c3p0.idleConnectionTestPeriod">15</prop>
      </props>
    </property>
    <property name="annotatedClasses">
      <list>
        <value>nl.surfnet.coin.shared.domain.DomainObject</value>
        <value>nl.surfnet.coin.portal.domain.Gadget</value>
        <value>nl.surfnet.coin.portal.domain.GadgetDefinition</value>
        <value>nl.surfnet.coin.portal.domain.SharedGadget</value>
        <value>nl.surfnet.coin.portal.domain.SharedTab</value>
        <value>nl.surfnet.coin.portal.domain.Tab</value>
        <value>nl.surfnet.coin.portal.domain.AbstractTab</value>
        <value>nl.surfnet.coin.portal.domain.TemplateTab</value>
        <value>nl.surfnet.coin.portal.domain.ClonedTab</value>
        <value>nl.surfnet.coin.portal.domain.SharedResource</value>
        <value>nl.surfnet.coin.portal.domain.Invite</value>
        <value>nl.surfnet.coin.portal.domain.TextContent</value>
        <value>nl.surfnet.coin.portal.domain.UserPreferences</value>
      </list>
    </property>
    <property name="namingStrategy">
      <bean class="org.hibernate.cfg.ImprovedNamingStrategy" />
    </property>
    <property name="useTransactionAwareDataSource" value="true" />
  </bean>

  <tx:annotation-driven transaction-manager="portalTransactionManager" />

  <bean id="portalTransactionManager"
    class="org.springframework.orm.hibernate3.HibernateTransactionManager">
    <property name="sessionFactory">
      <ref local="portalSessionFactory" />
    </property>
  </bean>

  <bean id="localeResolver"
    class="org.springframework.web.servlet.i18n.SessionLocaleResolver">
    <!-- Set the default Locale to English -->
    <property name="defaultLocale" value="en_EN" />
  </bean>
</beans>
